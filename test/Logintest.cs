using System.Net;
using System.Net.Http.Json;
using FluentAssertions;
using FluentAssertions.Execution;
using Infastructure;
using Newtonsoft.Json;
using Npgsql;

namespace test;

public class Credentials
{
    public string email { get; set; }
    public string password { get; set; }
}
[TestFixture]
public class Logintest
{
    private string apirUrl = "";
    private HttpClient _httpClient;

    private string resetDb = $@"
DROP SCHEMA IF EXISTS keepsocial CASCADE;
CREATE SCHEMA keepsocial;

create table if not exists keepsocial.users (
    id integer generated by default as identity,
    name VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    profileDescription VARCHAR(500),
    birthday DATE,
    avatarUrl VARCHAR,
    isDeleted boolean NOT NULL,
    constraint userpk
        primary key (id)
);


create table if not exists keepsocial.password_hash (
    user_id integer,
    hash VARCHAR(350) NOT NULL ,
    salt VARCHAR(180) NOT NULL ,
    algorithm VARCHAR(12) NOT NULL ,
    FOREIGN KEY(user_id) REFERENCES keepsocial.users(id)
);

create table if not exists keepsocial.chatrooms (
    rom_id integer generated by default as identity,
    rom_name VARCHAR,

    primary key (rom_id)
);

create table if not exists keepsocial.posts
(
    id integer generated by default as identity,
    author_id integer not null ,
    text VARCHAR(500) not null ,
    img_url VARCHAR,
    created timestamp not null,
    constraint postpk
        primary key (id),
    foreign key(author_id) references keepsocial.users(id)
);

create table if not exists keepsocial.chatroom_users_relation (
    rom_id integer ,
    user_id integer,

    FOREIGN KEY(rom_id) REFERENCES keepsocial.chatrooms(rom_id),
    FOREIGN KEY(user_id) REFERENCES keepsocial.users(id)
);

create table if not exists keepsocial.messages (
    id integer generated by default as identity,
    rom_id integer,
    user_id integer,
    message VARCHAR,
    time_Send timestamp,

    CONSTRAINT message_pk primary key (id),
    FOREIGN KEY(rom_id) REFERENCES keepsocial.chatrooms(rom_id),
    FOREIGN KEY(user_id) REFERENCES keepsocial.users(id)
);
create table if not exists keepsocial.friend_relation
(
    user1_id integer,
    user2_id integer,

    CONSTRAINT PK_friends PRIMARY KEY (user1_id, user2_id),
    FOREIGN KEY (user1_id) REFERENCES keepsocial.users (id),
    FOREIGN KEY (user2_id) REFERENCES keepsocial.users (id)
);

create table if not exists keepsocial.friend_request_table
(
    request_id integer generated by default as identity,
    requester integer,
    requested integer,
    response bool,

    CONSTRAINT PK_friendRequest PRIMARY KEY (request_id),
    FOREIGN KEY (requester) REFERENCES keepsocial.users (id),
    FOREIGN KEY (requested) REFERENCES keepsocial.users (id)
);

create table if not exists keepsocial.validation_numbers
(
  user_id integer NOT NULL,
  validation_number integer NOT NULL,
  created timestamp not null,
  FOREIGN KEY (user_id) REFERENCES keepsocial.users(id)
);

create table if not exists keepsocial.comments
(
   id integer generated by default as identity,
   post_id integer not null,
   author_id integer not null,
   text VARCHAR(500) not null,
   img_url varchar,
   created timestamp not null,
   primary key (id),
   foreign key(post_id) references keepsocial.posts(id),
   foreign key (author_id) references keepsocial.users(id)
);

create table if not exists keepsocial.follow_relation
(
    followed_id INT NOT NULL,
    follower_id INT NOT NULL,
    CONSTRAINT PK_follow PRIMARY KEY (followed_id, follower_id),
    FOREIGN KEY (followed_id) REFERENCES keepsocial.users(id),
    FOREIGN KEY (follower_id) REFERENCES keepsocial.users(id)
);

insert into keepsocial.users(id,name,email,birthday,isdeleted) values (111,'test tester','test@email.com',date('2023-02-24'),false);
insert into keepsocial.users(id,name,email,birthday,isdeleted) values (112,'test','isdeleted@email.com',date('2023-02-10'),true);
insert into keepsocial.password_hash(user_id,hash,salt,algorithm) values (111,'yfY6Hw8jaQO6HDGwCcC2RmO4QnjWRUMvL2BGJffBgy/51a1QH5grtXBCY4erDFV/Tpf5kFkkhrM7wAmLrMy8x2lHojaVTrt0T9sFKwZu3FvKW1WViCylor+4UeyX6aAUEbnBzFoUegQbf1IqC5cfbnmyT5Fb6u1YxB6uE6y1m/X/15VbwLpYH3TSVgr2p7rKC+HzCMechi7MdABZml9QrYEzgn21ViA0wuEk8vxCwxjdU9cAJQiGzNt0VBQ0Sh9CNGbsDndegX/IzQYZlwjYVbeFbyTaVEEB6u2w+5Gtpdg++tQQx1wlBZTnRxMB1NVhqAKsgKhWkD58NYTA+VoV1Q==','npTtNPhSUDkDDEoRqNF+fNG/ZLyayMkBSpdhQuXP72QGkSWBKzm3MuVmz9oxSfjCLcTYB8AfyjcgUGVVrPfOxcnV3jCRWq5DeEVsm3L7JkI5rkEY30OlcomaT7VDMlu0N+S96g3lYfesG80NZQS/xaO2Qq/B8F1tb8na4nT840M=','argon2id');
insert into keepsocial.password_hash(user_id,hash,salt,algorithm) values (112,'WWnDFi0C+RSi94i08E446PldkD07IdE6X0L1vwF+pPH6gZ+2GHTEzcbx0VRcgrdiSMWZuDGv6rvepcbYLgs7ChjE4Je86dAn2ec13nY2xqdtFb0EzY/HWOvXukBMAjgZrQJJxXYbWsax/q8Xsbwt/65EsTmuhoAtXZBTaGzyJ7OO8Qr50dlfeUw0WnqMYVNfM0JMRJsbYF+8jAYLdOxr4G+czIq2nrjqNVdWmtYOlkUWkORWwQCGnQJoJkbElvHdENVACbpqMT2+8DzEfMz0YTMd9KSqRh4w9oBm8Fp54lPAziwLOXPeUA5OULVR7rJbaRX/PHZwB5KPrVXcdM+PAQ==','UdzXfqmbj/yDWVPLSkAX4J668TZ07iG4BE8DQIe6zdOo3UgPz8nkq7FEIkwB48Etmh56tqIMaQCBvejXO10IFHjMUnYj5vyGwcFMyqo1xmnqddmzVDGp1QuvpxBwyUOCT3dkGUcoGzdmgZwXFCfB83APEXNe7pux2U/lhujMHV4=','argon2id');
";

 
    
    [SetUp]
    public void Setup()
    {
        _httpClient = new HttpClient();
        apirUrl = "http://localhost:5000/api/account/login";
    }

    [Test]
    public async Task LoginValidUser()
    {
        Helper.TriggerRebuild(resetDb);
        
        var cred = new Credentials { email = "test@email.com", password = "testtest" };

        HttpResponseMessage response;
        try
        {
            response = await _httpClient.PostAsJsonAsync(apirUrl, cred);
            TestContext.WriteLine("full body response: " + await response.Content.ReadAsStringAsync());
        }
        catch (Exception e)
        {
            throw new Exception("there was no response", e);
        }
        Jwt result;
        try
        {
            result = JsonConvert.DeserializeObject<Jwt>(await response.Content.ReadAsStringAsync()) ??
                     throw new InvalidOperationException();
        }
        catch (Exception e)
        {
            throw new Exception(Helper.BadResponseBody("bad response"), e);
        }
        
        
        using (new AssertionScope())
        {
            response.StatusCode.Should().Be(HttpStatusCode.OK);
            result.token.Should().NotBe(null);
        }
        
    }


    [TestCase("test@email.com","jwnuigbenwif")]
    [TestCase("tasts@email.com","testtest")]
    [TestCase("isdeleted@email.com","testtest3")]
    public async Task LoginInvalid(string email, string password)
    {
        Helper.TriggerRebuild(resetDb);
        
        var cred = new Credentials { email = email, password = password };

        HttpResponseMessage response;
        try
        {
            response = await _httpClient.PostAsJsonAsync(apirUrl, cred);
            TestContext.WriteLine("full body response: " + await response.Content.ReadAsStringAsync());
        }
        catch (Exception e)
        {
            throw new Exception("there was no response", e);
        }
        
        using (new AssertionScope())
        {
            response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);
        }
    }
}




public class Jwt
{
    public string token { get; set; }
}